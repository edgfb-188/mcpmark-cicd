name: Pull Request Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

jobs:
  code-quality:
    name: code-quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        id: eslint
        run: |
          echo "## ESLint Results" > eslint-results.txt
          npm run lint -- --format=json --output-file=eslint-report.json 2>&1 || echo "ESLint found issues"
          if [ -f eslint-report.json ]; then
            eslint_errors=$(cat eslint-report.json | jq '[.[] | select(.errorCount > 0)] | length')
            eslint_warnings=$(cat eslint-report.json | jq '[.[] | select(.warningCount > 0)] | length')
            echo "ESLint Errors: $eslint_errors" >> eslint-results.txt
            echo "ESLint Warnings: $eslint_warnings" >> eslint-results.txt
            echo "eslint_errors=$eslint_errors" >> $GITHUB_OUTPUT
            echo "eslint_warnings=$eslint_warnings" >> $GITHUB_OUTPUT
          else
            echo "No ESLint issues found!" >> eslint-results.txt
            echo "eslint_errors=0" >> $GITHUB_OUTPUT
            echo "eslint_warnings=0" >> $GITHUB_OUTPUT
          fi

      - name: Run Prettier check
        id: prettier
        run: |
          echo "## Prettier Results" > prettier-results.txt
          npm run format:check 2>&1 | tee prettier-output.txt || true
          if grep -q "Code style issues found" prettier-output.txt; then
            prettier_issues=$(grep -c "Code style issues found" prettier-output.txt || echo "0")
            echo "Prettier Issues: $prettier_issues files need formatting" >> prettier-results.txt
            echo "prettier_issues=$prettier_issues" >> $GITHUB_OUTPUT
          else
            echo "All files are properly formatted!" >> prettier-results.txt
            echo "prettier_issues=0" >> $GITHUB_OUTPUT
          fi

      - name: Post Code Quality Report
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            const eslintErrors = '${{ steps.eslint.outputs.eslint_errors }}' || '0';
            const eslintWarnings = '${{ steps.eslint.outputs.eslint_warnings }}' || '0';
            const prettierIssues = '${{ steps.prettier.outputs.prettier_issues }}' || '0';
            
            const status = (eslintErrors === '0' && prettierIssues === '0') ? '✅ PASSED' : '⚠️ ISSUES FOUND';
            
            const body = `## Code Quality Report
            
            **Status:** ${status}
            
            ### ESLint Results
            - Errors: ${eslintErrors}
            - Warnings: ${eslintWarnings}
            
            ### Prettier Results
            - Files needing formatting: ${prettierIssues}
            
            ---
            *Generated by PR Automation Workflow* | ${new Date().toISOString()}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  testing-suite:
    name: testing-suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        id: tests
        run: |
          echo "## Test Results" > test-results.txt
          npm test -- --coverage --coverageReporters=text --coverageReporters=json --coverageReporters=lcov 2>&1 | tee test-output.txt || true
          
          if [ -f coverage/coverage-summary.json ]; then
            total_lines=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
            total_statements=$(cat coverage/coverage-summary.json | jq '.total.statements.pct')
            total_functions=$(cat coverage/coverage-summary.json | jq '.total.functions.pct')
            total_branches=$(cat coverage/coverage-summary.json | jq '.total.branches.pct')
            
            echo "Coverage Summary:" >> test-results.txt
            echo "- Lines: ${total_lines}%" >> test-results.txt
            echo "- Statements: ${total_statements}%" >> test-results.txt
            echo "- Functions: ${total_functions}%" >> test-results.txt
            echo "- Branches: ${total_branches}%" >> test-results.txt
            
            echo "coverage_lines=$total_lines" >> $GITHUB_OUTPUT
            echo "coverage_statements=$total_statements" >> $GITHUB_OUTPUT
            echo "coverage_functions=$total_functions" >> $GITHUB_OUTPUT
            echo "coverage_branches=$total_branches" >> $GITHUB_OUTPUT
          fi
          
          if grep -q "Tests:" test-output.txt; then
            test_summary=$(grep "Tests:" test-output.txt | head -1)
            echo "test_summary=$test_summary" >> $GITHUB_OUTPUT
          fi

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            coverage/
            !coverage/node_modules/
          retention-days: 7

      - name: Post Test Coverage Report
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const lines = '${{ steps.tests.outputs.coverage_lines }}' || 'N/A';
            const statements = '${{ steps.tests.outputs.coverage_statements }}' || 'N/A';
            const functions = '${{ steps.tests.outputs.coverage_functions }}' || 'N/A';
            const branches = '${{ steps.tests.outputs.coverage_branches }}' || 'N/A';
            const testSummary = '${{ steps.tests.outputs.test_summary }}' || 'Tests completed';
            
            const avgCoverage = (lines !== 'N/A' && statements !== 'N/A' && functions !== 'N/A' && branches !== 'N/A') 
              ? ((parseFloat(lines) + parseFloat(statements) + parseFloat(functions) + parseFloat(branches)) / 4).toFixed(2)
              : 'N/A';
            
            const status = (avgCoverage !== 'N/A' && parseFloat(avgCoverage) >= 80) ? '✅ PASSED' : '⚠️ NEEDS IMPROVEMENT';
            
            const body = `## Test Coverage Report
            
            **Status:** ${status}
            
            ### Test Summary
            ${testSummary}
            
            ### Coverage Details
            - **Lines:** ${lines}%
            - **Statements:** ${statements}%
            - **Functions:** ${functions}%
            - **Branches:** ${branches}%
            - **Average Coverage:** ${avgCoverage}%
            
            ---
            *Generated by PR Automation Workflow* | ${new Date().toISOString()}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  security-scan:
    name: security-scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run dependency vulnerability check
        id: security
        run: |
          echo "## Security Scan Results" > security-results.txt
          
          # Run npm audit
          npm audit --audit-level=moderate --json > audit-report.json 2>&1 || true
          
          if [ -f audit-report.json ]; then
            vulnerabilities=$(cat audit-report.json | jq '.metadata.vulnerabilities // empty' 2>/dev/null || echo "null")
            if [ "$vulnerabilities" != "null" ] && [ "$vulnerabilities" != "" ]; then
              critical=$(echo $vulnerabilities | jq '.critical // 0')
              high=$(echo $vulnerabilities | jq '.high // 0')
              moderate=$(echo $vulnerabilities | jq '.moderate // 0')
              low=$(echo $vulnerabilities | jq '.low // 0')
              
              echo "Vulnerabilities Found:" >> security-results.txt
              echo "- Critical: $critical" >> security-results.txt
              echo "- High: $high" >> security-results.txt
              echo "- Moderate: $moderate" >> security-results.txt
              echo "- Low: $low" >> security-results.txt
              
              echo "vuln_critical=$critical" >> $GITHUB_OUTPUT
              echo "vuln_high=$high" >> $GITHUB_OUTPUT
              echo "vuln_moderate=$moderate" >> $GITHUB_OUTPUT
              echo "vuln_low=$low" >> $GITHUB_OUTPUT
            else
              echo "No vulnerabilities found!" >> security-results.txt
              echo "vuln_critical=0" >> $GITHUB_OUTPUT
              echo "vuln_high=0" >> $GITHUB_OUTPUT
              echo "vuln_moderate=0" >> $GITHUB_OUTPUT
              echo "vuln_low=0" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Scan for secrets in code changes
        id: secrets
        run: |
          echo "## Secrets Scan Results" > secrets-results.txt
          
          # Use a simple regex scan for common secret patterns
          secret_patterns=0
          
          # Scan for common secret patterns
          if git diff --name-only HEAD~1..HEAD 2>/dev/null; then
            changed_files=$(git diff --name-only HEAD~1..HEAD)
          else
            changed_files=$(git ls-files)
          fi
          
          for file in $changed_files; do
            if [ -f "$file" ]; then
              # Skip binary files and common non-code files
              if file "$file" | grep -q "text"; then
                # Look for common secret patterns
                patterns_found=$(grep -i -E '(password|secret|key|token|api[_-]?key|access[_-]?token|private[_-]?key)[:=]\s*["\'][^"\']{8,}["\']' "$file" | wc -l || echo "0")
                secret_patterns=$((secret_patterns + patterns_found))
              fi
            fi
          done
          
          if [ $secret_patterns -gt 0 ]; then
            echo "Potential secrets found: $secret_patterns" >> secrets-results.txt
            echo "secrets_found=$secret_patterns" >> $GITHUB_OUTPUT
          else
            echo "No secrets detected!" >> secrets-results.txt
            echo "secrets_found=0" >> $GITHUB_OUTPUT
          fi

      - name: Post Security Scan Report
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const critical = '${{ steps.security.outputs.vuln_critical }}' || '0';
            const high = '${{ steps.security.outputs.vuln_high }}' || '0';
            const moderate = '${{ steps.security.outputs.vuln_moderate }}' || '0';
            const low = '${{ steps.security.outputs.vuln_low }}' || '0';
            const secrets = '${{ steps.secrets.outputs.secrets_found }}' || '0';
            
            const totalVulns = parseInt(critical) + parseInt(high) + parseInt(moderate) + parseInt(low);
            const status = (totalVulns === 0 && secrets === '0') ? '✅ PASSED' : '⚠️ ISSUES FOUND';
            
            const body = `## Security Scan Report
            
            **Status:** ${status}
            
            ### Dependencies Vulnerabilities
            - **Critical:** ${critical}
            - **High:** ${high}
            - **Moderate:** ${moderate}
            - **Low:** ${low}
            - **Total:** ${totalVulns}
            
            ### Secrets Detection
            - **Potential secrets found:** ${secrets}
            
            ---
            *Generated by PR Automation Workflow* | ${new Date().toISOString()}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  build-validation:
    name: build-validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        id: build
        run: |
          echo "## Build Validation Results" > build-results.txt
          
          if npm run build 2>&1 | tee build-output.txt; then
            echo "Build Status: SUCCESS" >> build-results.txt
            echo "build_status=success" >> $GITHUB_OUTPUT
            
            # Check if build artifacts exist
            if [ -d "dist" ] || [ -d "build" ]; then
              echo "Build artifacts created successfully" >> build-results.txt
              echo "artifacts_created=true" >> $GITHUB_OUTPUT
            else
              echo "No build artifacts found" >> build-results.txt
              echo "artifacts_created=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Build Status: FAILED" >> build-results.txt
            echo "build_status=failed" >> $GITHUB_OUTPUT
            echo "artifacts_created=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate endpoints (if applicable)
        id: endpoints
        if: steps.build.outputs.build_status == 'success'
        run: |
          echo "## Endpoint Validation" > endpoint-results.txt
          
          # Check if this is a web application with endpoints
          if [ -f "package.json" ]; then
            has_start_script=$(cat package.json | jq '.scripts.start // empty' | wc -c)
            if [ $has_start_script -gt 1 ]; then
              echo "Start script detected - endpoints may be available after deployment" >> endpoint-results.txt
              echo "endpoints_available=true" >> $GITHUB_OUTPUT
            else
              echo "No start script found - static build completed" >> endpoint-results.txt
              echo "endpoints_available=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No package.json found" >> endpoint-results.txt
            echo "endpoints_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Create deployment preview artifacts
        if: steps.build.outputs.build_status == 'success' && steps.build.outputs.artifacts_created == 'true'
        run: |
          mkdir -p deployment-preview
          if [ -d "dist" ]; then
            cp -r dist/* deployment-preview/ 2>/dev/null || true
          elif [ -d "build" ]; then
            cp -r build/* deployment-preview/ 2>/dev/null || true
          fi

      - name: Upload deployment preview
        uses: actions/upload-artifact@v4
        if: steps.build.outputs.build_status == 'success' && steps.build.outputs.artifacts_created == 'true'
        with:
          name: deployment-preview
          path: deployment-preview/
          retention-days: 7

      - name: Post Build Validation Report
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const buildStatus = '${{ steps.build.outputs.build_status }}' || 'unknown';
            const artifactsCreated = '${{ steps.build.outputs.artifacts_created }}' || 'false';
            const endpointsAvailable = '${{ steps.endpoints.outputs.endpoints_available }}' || 'false';
            
            const status = (buildStatus === 'success') ? '✅ PASSED' : '❌ FAILED';
            
            const body = `## Build Validation
            
            **Status:** ${status}
            
            ### Build Results
            - **Build Status:** ${buildStatus}
            - **Artifacts Created:** ${artifactsCreated}
            - **Endpoints Available:** ${endpointsAvailable}
            
            ### Deployment Preview
            ${artifactsCreated === 'true' ? '✅ Deployment preview artifacts have been created and uploaded.' : '⚠️ No deployment preview available.'}
            
            ---
            *Generated by PR Automation Workflow* | ${new Date().toISOString()}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });